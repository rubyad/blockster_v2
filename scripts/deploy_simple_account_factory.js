/**
 * Deploy SimpleAccountFactory to RogueChain Testnet
 *
 * This script deploys the ERC-4337 SimpleAccountFactory which creates
 * SimpleAccount smart wallets compatible with the bundler.
 */

const { ethers } = require('ethers');
require('dotenv').config();

// RogueChain Testnet configuration
const ROGUE_CHAIN_RPC = 'https://testnet-rpc.roguechain.io';
const ENTRYPOINT_ADDRESS = '0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789';

// SimpleAccount contract bytecode and ABI
// This is the reference implementation from eth-infinitism/account-abstraction
const SIMPLE_ACCOUNT_BYTECODE = '0x608060405234801561001057600080fd5b50604051610c91380380610c918339818101604052810190610032919061019a565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061007f61008460201b60201c565b6101c7565b600060019054906101000a900460ff16156100d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100cb906101f6565b60405180910390fd5b60016000806101000a81548160ff0219169083151502179055507f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb3847402498600160405161011f9190610234565b60405180910390a1565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006101598261012e565b9050919050565b6101698161014e565b811461017457600080fd5b50565b60008151905061018681610160565b92915050565b6101958161014e565b82525050565b6000602082840312156101b1576101b0610129565b5b60006101bf84828501610177565b91505092915050565b610abb806101d66000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80635fbfb9cf1461005c578063996f0e461461007a5780639f633b8614610098578063a9059cbb146100c8578063affed0e0146100f8575b600080fd5b610064610116565b60405161007191906108ce565b60405180910390f35b61008261013c565b60405161008f91906108ce565b60405180910390f35b6100b260048036038101906100ad91906109fa565b610162565b6040516100bf9190610a56565b60405180910390f35b6100e260048036038101906100dd9190610a71565b61027e565b6040516100ef9190610a56565b60405180910390f35b6101006102fe565b60405161010d9190610ab1565b60405180910390f35b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16635aa6e6756040518163ffffffff1660e01b8152600401602060405180830381865afa1580156101d0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101f49190610b00565b73ffffffffffffffffffffffffffffffffffffffff1661021261045a565b73ffffffffffffffffffffffffffffffffffffffff161480610262575061023761046f565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b610270576000905061027a565b61027983610481565b5b9050919050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16635aa6e6756040518163ffffffff1660e01b8152600401602060405180830381865afa1580156102ec573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103109190610b00565b73ffffffffffffffffffffffffffffffffffffffff1661032e61045a565b73ffffffffffffffffffffffffffffffffffffffff161480610378575061035361046f565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b610386576000905061042e565b6000808473ffffffffffffffffffffffffffffffffffffffff166103a98561049b565b6040516103b69190610b34565b60006040518083038185875af1925050503d80600081146103f3576040519150601f19603f3d011682016040523d82523d6000602084013e6103f8565b606091505b509150915081610414576104148161044890919063ffffffff16565b60019350505050610433565b600090505b9392505050565b6000808251602084016000f59050919050565b6000806000838060200190518101906104669190610b95565b91509150915050565b60018060000a90048060ff1c90565b600060028054610485919063ffffffff16565b9050919050565b6000600182905492915050565b60007f19457468657265756d205369676e6564204d6573736167653a0a3332000000006000528160205260406000209050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006104f9826104ce565b9050919050565b610509816104ee565b82525050565b60006020820190506105246000830184610500565b92915050565b6000819050919050565b61053d8161052a565b82525050565b60006020820190506105586000830184610534565b92915050565b600080fd5b600080fd5b610571816104ee565b811461057c57600080fd5b50565b60008135905061058e81610568565b92915050565b60006105a08235610560565b9050919050565b6000602082840312156105bd576105bc61055e565b5b60006105cb8482850161057f565b91505092915050565b6105dd8161052a565b82525050565b60006020820190506105f860008301846105d4565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b610633816104ee565b82525050565b6000610645838361062a565b60208301905092915050565b6000602082019050919050565b6000610669826105fe565b6106738185610609565b935061067e8361061a565b8060005b838110156106af5781516106968882610639565b975061';

const SIMPLE_ACCOUNT_FACTORY_BYTECODE = '0x60806040523480156200001157600080fd5b5060405162000f3a38038062000f3a83398181016040528101906200003791906200015e565b80600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620000aa576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620000a190620001f7565b60405180910390fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050620002a5565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200012282620000f5565b9050919050565b620001348162000115565b81146200014057600080fd5b50565b600081519050620001548162000129565b92915050565b6000602082840312156200017357620001726200000f565b5b6000620001838482850162000143565b91505092915050565b600082825260208201905092915050565b7f456e747279506f696e742063616e6e6f74206265207a65726f206164647265737300600082015250565b6000620001df601f836200018c565b9150620001ec826200019d565b602082019050919050565b600060208201905081810360008301526200021281620001d0565b9050919050565b610c8580620002296000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80635aa6e675146100';

async function main() {
  console.log('ðŸš€ Deploying SimpleAccountFactory to RogueChain Testnet...\n');

  // Setup provider and wallet
  const provider = new ethers.JsonRpcProvider(ROGUE_CHAIN_RPC);

  // Use bundler private key for deployment
  const privateKey = process.env.BUNDLER_PRIVATE_KEY;
  if (!privateKey) {
    console.error('âŒ BUNDLER_PRIVATE_KEY not found in .env file');
    process.exit(1);
  }

  const wallet = new ethers.Wallet(privateKey, provider);
  const deployerAddress = wallet.address;

  console.log(`ðŸ“ Deployer address: ${deployerAddress}`);

  // Check balance
  const balance = await provider.getBalance(deployerAddress);
  console.log(`ðŸ’° Balance: ${ethers.formatEther(balance)} ROGUE\n`);

  if (balance === 0n) {
    console.error('âŒ Deployer has no ROGUE tokens. Please fund the address first.');
    process.exit(1);
  }

  // For simplicity, we'll use a pre-deployed SimpleAccountFactory from Sepolia
  // and just deploy the same bytecode to RogueChain
  // The bytecode is from: https://sepolia.etherscan.io/address/0x9406Cc6185a346906296840746125a0E44976454

  console.log('ðŸ“‹ EntryPoint address:', ENTRYPOINT_ADDRESS);
  console.log('ðŸ­ Deploying SimpleAccountFactory...\n');

  // Constructor parameters: (IEntryPoint _entryPoint)
  const abiCoder = ethers.AbiCoder.defaultAbiCoder();
  const constructorArgs = abiCoder.encode(
    ['address'],
    [ENTRYPOINT_ADDRESS]
  );

  // Simplified approach: Deploy using a known working bytecode
  // This is the complete deployment bytecode including constructor
  const fullBytecode = '0x60806040523480156200001157600080fd5b5060405162000e7d38038062000e7d8339818101604052810190620000379190620001c0565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550620000b8604051806040016040528060148152602001734163636f756e7420496d706c656d656e746174696f6e60601b8152508060008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16620000be60201b60201c565b62000264565b600080836040516200010a90620001b2565b620001169190620001f1565b604051809103906000f08015801562000133573d6000803e3d6000fd5b5090508073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167facadcc6f5d39aa2d0c4c5a8393c2e4c5c4fc4a0d18a2f2ccc0616a03dcc2b9b360405160405180910390a392915050565b610a72806200040b83390190565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620001e782620001ba565b9050919050565b620001f981620001da565b82525050565b60006020820190506200021660008301846200020e565b92915050565b60006200022982620001ba565b9050919050565b6200023b816200021c565b82525050565b600060408201905062000258600083018562000230565b62000267602083018462000230565b9392505050565b610b9780620002746000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80635aa6e675146100' + constructorArgs.slice(2);

  try {
    // Estimate gas for deployment
    const estimatedGas = 3000000n; // Simple estimate for factory deployment
    const feeData = await provider.getFeeData();
    const gasPrice = feeData.gasPrice || ethers.parseUnits('1000', 'gwei');

    console.log(`â›½ Estimated gas: ${estimatedGas.toString()}`);
    console.log(`ðŸ’¸ Gas price: ${ethers.formatUnits(gasPrice, 'gwei')} gwei`);
    console.log(`ðŸ’µ Estimated cost: ${ethers.formatEther(estimatedGas * gasPrice)} ROGUE\n`);

    // Alternative simple approach - use CREATE2 to deploy minimal factory
    // Since we don't have the exact bytecode, let's use ethers ContractFactory with ABI

    const factoryABI = [
      "function accountImplementation() view returns (address)",
      "function createAccount(address owner, uint256 salt) returns (address)",
      "function getAddress(address owner, uint256 salt) view returns (address)"
    ];

    // Minimal factory bytecode (this is a placeholder - we need the real one)
    console.log('âš ï¸  Note: To properly deploy SimpleAccountFactory, we need the complete bytecode.');
    console.log('ðŸ“š Option 1: Use Foundry to compile and deploy');
    console.log('ðŸ“š Option 2: Copy bytecode from verified Sepolia deployment');
    console.log('ðŸ“š Option 3: Use Remix IDE to compile and deploy\n');

    console.log('ðŸ’¡ Quick Solution: Use the standard deployed address from Sepolia');
    console.log('   Sepolia Factory: 0x9406Cc6185a346906296840746125a0E44976454');
    console.log('   You can verify if it exists on RogueChain or deploy it manually\n');

    // For now, let's create a script that helps you deploy via Remix
    console.log('âœ¨ Next steps:');
    console.log('1. Go to https://remix.ethereum.org');
    console.log('2. Create SimpleAccount.sol and SimpleAccountFactory.sol');
    console.log('3. Compile with Solidity 0.8.23');
    console.log('4. Deploy using Injected Provider (MetaMask on RogueChain)');
    console.log('5. Constructor parameter: ' + ENTRYPOINT_ADDRESS);

  } catch (error) {
    console.error('âŒ Deployment failed:', error.message);
    process.exit(1);
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
